name: Docker Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  docker-integration-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        maya-version: ["2022"]  # Start with 2022, add others as needed
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'  # Compatible with Maya 2022
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
    
    - name: Check Docker
      run: |
        docker --version
        docker info
    
    - name: Pull Maya Docker image
      run: |
        echo "Pulling Maya ${{ matrix.maya-version }} Docker image..."
        docker pull mottosso/maya:${{ matrix.maya-version }}
        docker images mottosso/maya
    
    - name: Prepare test environment
      run: |
        # Create necessary directories
        mkdir -p test-results
        
        # Set permissions for Docker volume mounting
        chmod -R 755 .
    
    - name: Run Docker integration tests
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          -e PYTHONPATH=/workspace \
          -e MAYA_DISABLE_CIP=1 \
          -e MAYA_DISABLE_CER=1 \
          mottosso/maya:${{ matrix.maya-version }} \
          mayapy -c "
          import sys
          sys.path.insert(0, '/workspace')

          try:
              import maya.standalone
              maya.standalone.initialize()

              # Test Maya Umbrella imports
              from maya_umbrella import MayaVirusDefender, MayaVirusScanner
              from maya_umbrella.vaccines import get_all_vaccines

              print('SUCCESS: Maya Umbrella imports successful')
              print(f'Available vaccines: {len(get_all_vaccines())}')

              # Test basic defender functionality
              import maya.cmds as cmds
              cmds.file(new=True, force=True)

              defender = MayaVirusDefender()
              defender.start()

              print(f'Defender test - Issues detected: {defender.have_issues}')
              print('SUCCESS: Docker integration test completed')

              maya.standalone.uninitialize()

          except Exception as e:
              print(f'ERROR: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "
    
    - name: Test basic Maya functionality
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          -e PYTHONPATH=/workspace \
          -e MAYA_DISABLE_CIP=1 \
          -e MAYA_DISABLE_CER=1 \
          mottosso/maya:${{ matrix.maya-version }} \
          mayapy -c "
          import maya.standalone
          maya.standalone.initialize()
          import maya.cmds as cmds
          print('Maya version:', cmds.about(version=True))
          print('Maya build:', cmds.about(buildDirectory=True))
          maya.standalone.uninitialize()
          print('SUCCESS: Basic Maya test completed')
          "
    
    - name: Test Maya Umbrella import
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          -e PYTHONPATH=/workspace \
          -e MAYA_DISABLE_CIP=1 \
          -e MAYA_DISABLE_CER=1 \
          mottosso/maya:${{ matrix.maya-version }} \
          mayapy -c "
          import sys
          sys.path.insert(0, '/workspace')
          import maya.standalone
          maya.standalone.initialize()
          
          try:
              from maya_umbrella import MayaVirusDefender, MayaVirusScanner
              from maya_umbrella.vaccines import get_all_vaccines
              print('SUCCESS: Maya Umbrella imported successfully')
              print(f'Available vaccines: {len(get_all_vaccines())}')
          except Exception as e:
              print(f'ERROR: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          finally:
              maya.standalone.uninitialize()
          "
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: docker-test-results-maya-${{ matrix.maya-version }}
        path: test-results/
        retention-days: 7

  docker-integration-test-extended:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # Only run on manual trigger
    strategy:
      matrix:
        maya-version: ["2023", "2024"]
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
    
    - name: Pull Maya Docker image
      run: |
        echo "Pulling Maya ${{ matrix.maya-version }} Docker image..."
        docker pull mottosso/maya:${{ matrix.maya-version }} || echo "Image not available"
    
    - name: Run extended tests (if image available)
      run: |
        if docker images -q mottosso/maya:${{ matrix.maya-version }} | grep -q .; then
          echo "Running tests with Maya ${{ matrix.maya-version }}"
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e PYTHONPATH=/workspace \
            -e MAYA_DISABLE_CIP=1 \
            -e MAYA_DISABLE_CER=1 \
            mottosso/maya:${{ matrix.maya-version }} \
            mayapy -c "
            import sys
            sys.path.insert(0, '/workspace')

            try:
                import maya.standalone
                maya.standalone.initialize()

                from maya_umbrella import MayaVirusDefender
                print('SUCCESS: Maya ${{ matrix.maya-version }} integration test passed')

                maya.standalone.uninitialize()

            except Exception as e:
                print(f'ERROR: {e}')
                sys.exit(1)
            "
        else
          echo "Maya ${{ matrix.maya-version }} image not available, skipping"
        fi

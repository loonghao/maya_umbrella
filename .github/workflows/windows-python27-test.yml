name: Windows Python 2.7 Compatibility Tests

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  windows-python27:
    name: Windows Python 2.7 Compatibility
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python 2.7
      uses: actions/setup-python@v4
      with:
        python-version: '2.7'
    
    - name: Install Python 2.7 dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-mock
        # Install any other Python 2.7 compatible dependencies
        echo "Python 2.7 dependencies installed"
    
    - name: Test Python 2.7 Environment
      run: |
        python -c "
import sys
import platform
print('=' * 60)
print('Windows Python 2.7 Compatibility Test')
print('=' * 60)
print('Python version:', sys.version)
print('Python executable:', sys.executable)
print('Platform:', platform.platform())
print('Architecture:', platform.architecture())
"
    
    - name: Test Core Module Imports (Python 2.7)
      run: |
        python -c "
import sys
import os

# Add project root to Python path
project_root = os.getcwd()
sys.path.insert(0, project_root)

try:
    print('\\n--- Testing Core Module Imports ---')
    
    # Test filesystem utilities
    from maya_umbrella.filesystem import write_file, read_file
    print('‚úÖ Filesystem utilities imported successfully')
    
    # Test vaccines module
    from maya_umbrella.vaccines import get_all_vaccines
    vaccines = get_all_vaccines()
    print('‚úÖ Vaccines module imported: {} vaccines available'.format(len(vaccines)))
    
    # List available vaccines
    for vaccine in vaccines:
        print('  - {}'.format(vaccine.__class__.__name__))
    
    # Test version module
    from maya_umbrella import __version__
    print('‚úÖ Version module imported: {}'.format(__version__))
    
    print('\\nüéâ All core module imports successful on Python 2.7!')
    
except Exception as e:
    print('‚ùå ERROR: {}'.format(e))
    import traceback
    traceback.print_exc()
    sys.exit(1)
"
    
    - name: Test Python 2.7 Syntax Compatibility
      run: |
        python -c "
import sys
import os
sys.path.insert(0, os.getcwd())

try:
    print('\\n--- Testing Python 2.7 Syntax Compatibility ---')
    
    # Test string formatting (Python 2.7 style)
    test_string = 'Test message: {}'.format('success')
    print('‚úÖ String formatting: {}'.format(test_string))
    
    # Test dictionary operations
    test_dict = {'key1': 'value1', 'key2': 'value2'}
    for key, value in test_dict.items():
        print('‚úÖ Dictionary iteration: {} = {}'.format(key, value))
    
    # Test list comprehensions
    test_list = [x * 2 for x in range(5)]
    print('‚úÖ List comprehension: {}'.format(test_list))
    
    # Test exception handling
    try:
        raise ValueError('Test exception')
    except ValueError as e:
        print('‚úÖ Exception handling: {}'.format(e))
    
    # Test file operations
    import tempfile
    temp_file = tempfile.mktemp(suffix='.txt')
    
    with open(temp_file, 'w') as f:
        f.write('Python 2.7 test content')
    
    with open(temp_file, 'r') as f:
        content = f.read()
    
    if content == 'Python 2.7 test content':
        print('‚úÖ File operations working correctly')
    
    os.remove(temp_file)
    
    print('\\nüéâ All Python 2.7 syntax compatibility tests passed!')
    
except Exception as e:
    print('‚ùå ERROR: {}'.format(e))
    import traceback
    traceback.print_exc()
    sys.exit(1)
"
    
    - name: Test File System Utilities (Python 2.7)
      run: |
        python -c "
import sys
import os
import tempfile
sys.path.insert(0, os.getcwd())

try:
    print('\\n--- Testing File System Utilities ---')
    
    from maya_umbrella.filesystem import write_file, read_file
    
    # Create temporary test file
    temp_dir = tempfile.mkdtemp()
    test_file = os.path.join(temp_dir, 'test_python27.txt')
    test_content = 'Maya Umbrella Python 2.7 Windows Test\\nLine 2\\nLine 3'
    
    # Test write_file
    write_file(test_file, test_content)
    print('‚úÖ write_file function works on Python 2.7')
    
    # Test read_file
    read_content = read_file(test_file)
    if read_content.strip() == test_content.strip():
        print('‚úÖ read_file function works on Python 2.7')
    else:
        raise Exception('File content mismatch')
    
    # Clean up
    os.remove(test_file)
    os.rmdir(temp_dir)
    
    print('\\n‚úÖ File system utilities compatible with Python 2.7')
    
except Exception as e:
    print('‚ùå ERROR: {}'.format(e))
    import traceback
    traceback.print_exc()
    sys.exit(1)
"
    
    - name: Test Vaccine Classes (Python 2.7)
      run: |
        python -c "
import sys
import os
sys.path.insert(0, os.getcwd())

try:
    print('\\n--- Testing Vaccine Classes ---')
    
    from maya_umbrella.vaccines import get_all_vaccines
    
    vaccines = get_all_vaccines()
    print('Found {} vaccine classes'.format(len(vaccines)))
    
    for vaccine_class in vaccines:
        try:
            vaccine_name = vaccine_class.__name__
            print('Testing vaccine class: {}'.format(vaccine_name))
            
            # Test class instantiation
            vaccine_instance = vaccine_class()
            print('  ‚úÖ {} instantiated successfully'.format(vaccine_name))
            
            # Test common attributes
            if hasattr(vaccine_instance, 'name'):
                print('  ‚úÖ {} has name attribute: {}'.format(vaccine_name, vaccine_instance.name))
            
            if hasattr(vaccine_instance, 'description'):
                print('  ‚úÖ {} has description attribute'.format(vaccine_name))
            
        except Exception as e:
            print('  ‚ùå {} failed: {}'.format(vaccine_name, e))
    
    print('\\n‚úÖ Vaccine class testing completed on Python 2.7')
    
except Exception as e:
    print('‚ùå ERROR: {}'.format(e))
    import traceback
    traceback.print_exc()
    sys.exit(1)
"

  windows-python27-summary:
    name: Windows Python 2.7 Test Summary
    runs-on: windows-latest
    needs: windows-python27
    if: always()
    
    steps:
    - name: Test Results Summary
      run: |
        echo "Windows Python 2.7 Compatibility Test Results:"
        echo "=============================================="
        
        if ("${{ needs.windows-python27.result }}" -eq "success") {
          echo "‚úÖ All Windows Python 2.7 tests passed successfully!"
          echo "   - Core module imports verified"
          echo "   - Python 2.7 syntax compatibility confirmed"
          echo "   - File system utilities working"
          echo "   - Vaccine classes compatible"
        } else {
          echo "‚ùå Some Windows Python 2.7 tests failed"
          echo "   Check the job logs for details"
          exit 1
        }
